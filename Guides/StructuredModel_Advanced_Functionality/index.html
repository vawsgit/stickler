
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../StructuredModel_Dynamic_Creation/">
      
      
        <link rel="next" href="../Universal_Aggregate_Field_Feature/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>StructuredModel Advanced Functionality - Stickler</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.84d31ad4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#structuredmodel-advanced-functionality-technical-deep-dive" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Stickler" class="md-header__button md-logo" aria-label="Stickler" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Stickler
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              StructuredModel Advanced Functionality
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/awslabs/stickler" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    awslabs/stickler
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../Getting-Started/" class="md-tabs__link">
          
  
  
  Getting Started

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../Core-Concepts/" class="md-tabs__link">
          
  
  
  Core Concepts

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../StructuredModel_compare_with_README/" class="md-tabs__link">
          
  
  
  Guides

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../SDK-Docs/" class="md-tabs__link">
          
  
  
  SDK Docs

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Stickler" class="md-nav__button md-logo" aria-label="Stickler" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Stickler
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/awslabs/stickler" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    awslabs/stickler
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Getting Started
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Getting-Started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Quick Start
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Getting-Started/known-issues/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Known Issues
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Core Concepts
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Core Concepts
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Core-Concepts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Core-Concepts/Classification_Logic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Classification Logic
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Core-Concepts/hungarian_matching_list_of_model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Hungarian Matching
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Core-Concepts/Threshold_Gated_Recursive_Evaluation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Recursive Evaluation
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Guides
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Guides
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../StructuredModel_compare_with_README/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    StructuredModel Compare
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../StructuredModel_Dynamic_Creation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    StructuredModel from JSON
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    StructuredModel Advanced Functionality
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    StructuredModel Advanced Functionality
    
  </span>
  

      </a>
      
        

  

<nav class="md-nav md-nav--secondary" aria-label="On this page">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      On this page
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#table-of-contents" class="md-nav__link">
    <span class="md-ellipsis">
      Table of Contents
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      Overview
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#core-recursive-engine" class="md-nav__link">
    <span class="md-ellipsis">
      Core Recursive Engine
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Core Recursive Engine">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#compare_recursiveself-other-structuredmodel-dict" class="md-nav__link">
    <span class="md-ellipsis">
      compare_recursive(self, other: 'StructuredModel') -&gt; dict
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compare_recursive(self, other: &#39;StructuredModel&#39;) -&gt; dict">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#function-signature-and-purpose" class="md-nav__link">
    <span class="md-ellipsis">
      Function Signature and Purpose
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#internal-structure" class="md-nav__link">
    <span class="md-ellipsis">
      Internal Structure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-innovations" class="md-nav__link">
    <span class="md-ellipsis">
      Key Innovations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#processing-loop" class="md-nav__link">
    <span class="md-ellipsis">
      Processing Loop
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#final-score-calculation" class="md-nav__link">
    <span class="md-ellipsis">
      Final Score Calculation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#field-dispatch-system" class="md-nav__link">
    <span class="md-ellipsis">
      Field Dispatch System
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Field Dispatch System">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_dispatch_field_comparisonself-field_name-str-gt_val-any-pred_val-any-dict" class="md-nav__link">
    <span class="md-ellipsis">
      _dispatch_field_comparison(self, field_name: str, gt_val: Any, pred_val: Any) -&gt; dict
    </span>
  </a>
  
    <nav class="md-nav" aria-label="_dispatch_field_comparison(self, field_name: str, gt_val: Any, pred_val: Any) -&gt; dict">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#key-responsibilities" class="md-nav__link">
    <span class="md-ellipsis">
      Key Responsibilities
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#match-based-type-detection" class="md-nav__link">
    <span class="md-ellipsis">
      Match-Based Type Detection
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#list-field-dispatch-with-match-statements" class="md-nav__link">
    <span class="md-ellipsis">
      List Field Dispatch with Match Statements
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#primitive-null-handling" class="md-nav__link">
    <span class="md-ellipsis">
      Primitive Null Handling
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#type-based-handler-selection" class="md-nav__link">
    <span class="md-ellipsis">
      Type-Based Handler Selection
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#specialized-comparison-handlers" class="md-nav__link">
    <span class="md-ellipsis">
      Specialized Comparison Handlers
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Specialized Comparison Handlers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_compare_primitive_with_scoresself-gt_val-any-pred_val-any-field_name-str-dict" class="md-nav__link">
    <span class="md-ellipsis">
      _compare_primitive_with_scores(self, gt_val: Any, pred_val: Any, field_name: str) -&gt; dict
    </span>
  </a>
  
    <nav class="md-nav" aria-label="_compare_primitive_with_scores(self, gt_val: Any, pred_val: Any, field_name: str) -&gt; dict">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#key-features" class="md-nav__link">
    <span class="md-ellipsis">
      Key Features
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_compare_primitive_list_with_scoresself-gt_list-listany-pred_list-listany-field_name-str-dict" class="md-nav__link">
    <span class="md-ellipsis">
      _compare_primitive_list_with_scores(self, gt_list: List[Any], pred_list: List[Any], field_name: str) -&gt; dict
    </span>
  </a>
  
    <nav class="md-nav" aria-label="_compare_primitive_list_with_scores(self, gt_list: List[Any], pred_list: List[Any], field_name: str) -&gt; dict">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#critical-design-decision-universal-hierarchical-structure" class="md-nav__link">
    <span class="md-ellipsis">
      Critical Design Decision: Universal Hierarchical Structure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#emptynull-handling" class="md-nav__link">
    <span class="md-ellipsis">
      Empty/Null Handling
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hungarian-matching-integration" class="md-nav__link">
    <span class="md-ellipsis">
      Hungarian Matching Integration
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_compare_struct_list_with_scoresself-gt_list-liststructuredmodel-pred_list-liststructuredmodel-field_name-str-dict" class="md-nav__link">
    <span class="md-ellipsis">
      _compare_struct_list_with_scores(self, gt_list: List['StructuredModel'], pred_list: List['StructuredModel'], field_name: str) -&gt; dict
    </span>
  </a>
  
    <nav class="md-nav" aria-label="_compare_struct_list_with_scores(self, gt_list: List[&#39;StructuredModel&#39;], pred_list: List[&#39;StructuredModel&#39;], field_name: str) -&gt; dict">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#critical-design-principle-object-level-vs-field-level-separation" class="md-nav__link">
    <span class="md-ellipsis">
      Critical Design Principle: Object-Level vs Field-Level Separation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#empty-case-handling-with-match-statements" class="md-nav__link">
    <span class="md-ellipsis">
      Empty Case Handling with Match Statements
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#object-level-metrics-calculation" class="md-nav__link">
    <span class="md-ellipsis">
      Object-Level Metrics Calculation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#field-level-details-generation-threshold-gated-recursion" class="md-nav__link">
    <span class="md-ellipsis">
      Field-Level Details Generation (Threshold-Gated Recursion)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hungarian-matching-integration_1" class="md-nav__link">
    <span class="md-ellipsis">
      Hungarian Matching Integration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Hungarian Matching Integration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-_compare_unordered_lists-method" class="md-nav__link">
    <span class="md-ellipsis">
      The _compare_unordered_lists() Method
    </span>
  </a>
  
    <nav class="md-nav" aria-label="The _compare_unordered_lists() Method">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#key-algorithm-features" class="md-nav__link">
    <span class="md-ellipsis">
      Key Algorithm Features
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Strategy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#threshold-based-classification" class="md-nav__link">
    <span class="md-ellipsis">
      Threshold-Based Classification
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#overall-score-calculation" class="md-nav__link">
    <span class="md-ellipsis">
      Overall Score Calculation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#score-aggregation-and-percolation" class="md-nav__link">
    <span class="md-ellipsis">
      Score Aggregation and Percolation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Score Aggregation and Percolation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-percolation-system" class="md-nav__link">
    <span class="md-ellipsis">
      The Percolation System
    </span>
  </a>
  
    <nav class="md-nav" aria-label="The Percolation System">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#score-types" class="md-nav__link">
    <span class="md-ellipsis">
      Score Types
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#weight-based-aggregation" class="md-nav__link">
    <span class="md-ellipsis">
      Weight-Based Aggregation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#all_fields_matched-determination" class="md-nav__link">
    <span class="md-ellipsis">
      all_fields_matched Determination
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aggregation-helper-_aggregate_to_overall" class="md-nav__link">
    <span class="md-ellipsis">
      Aggregation Helper: _aggregate_to_overall()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#threshold-gated-recursion" class="md-nav__link">
    <span class="md-ellipsis">
      Threshold-Gated Recursion
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Threshold-Gated Recursion">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-optimization-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      The Optimization Strategy
    </span>
  </a>
  
    <nav class="md-nav" aria-label="The Optimization Strategy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#implementation-in-list-processing" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation in List Processing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#benefits" class="md-nav__link">
    <span class="md-ellipsis">
      Benefits
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#performance-optimizations" class="md-nav__link">
    <span class="md-ellipsis">
      Performance Optimizations
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Performance Optimizations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#single-traversal-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Single Traversal Architecture
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lazy-evaluation" class="md-nav__link">
    <span class="md-ellipsis">
      Lazy Evaluation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#memory-efficiency" class="md-nav__link">
    <span class="md-ellipsis">
      Memory Efficiency
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hungarian-algorithm-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      Hungarian Algorithm Optimization
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#debugging-and-troubleshooting" class="md-nav__link">
    <span class="md-ellipsis">
      Debugging and Troubleshooting
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Debugging and Troubleshooting">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#common-issues-and-solutions" class="md-nav__link">
    <span class="md-ellipsis">
      Common Issues and Solutions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Common Issues and Solutions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-incorrect-similarity-scores" class="md-nav__link">
    <span class="md-ellipsis">
      1. Incorrect Similarity Scores
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-confusion-matrix-inconsistencies" class="md-nav__link">
    <span class="md-ellipsis">
      2. Confusion Matrix Inconsistencies
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-performance-issues" class="md-nav__link">
    <span class="md-ellipsis">
      3. Performance Issues
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-memory-usage" class="md-nav__link">
    <span class="md-ellipsis">
      4. Memory Usage
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#debugging-helper-methods" class="md-nav__link">
    <span class="md-ellipsis">
      Debugging Helper Methods
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-complex-scenarios" class="md-nav__link">
    <span class="md-ellipsis">
      Testing Complex Scenarios
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#profiling-guidelines" class="md-nav__link">
    <span class="md-ellipsis">
      Profiling Guidelines
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-performance-metrics-to-monitor" class="md-nav__link">
    <span class="md-ellipsis">
      Key Performance Metrics to Monitor
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#code-maintenance-guidelines" class="md-nav__link">
    <span class="md-ellipsis">
      Code Maintenance Guidelines
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    <span class="md-ellipsis">
      Conclusion
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Universal_Aggregate_Field_Feature/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Universal Aggregate Field
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    SDK Docs
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            SDK Docs
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../SDK-Docs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SDK Documentation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../SDK-Docs/api/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../SDK-Docs/comparators/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Comparators
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../SDK-Docs/evaluator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Evaluator
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../SDK-Docs/models/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Models
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../SDK-Docs/utils/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Utils
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  

<nav class="md-nav md-nav--secondary" aria-label="On this page">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      On this page
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#table-of-contents" class="md-nav__link">
    <span class="md-ellipsis">
      Table of Contents
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      Overview
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#core-recursive-engine" class="md-nav__link">
    <span class="md-ellipsis">
      Core Recursive Engine
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Core Recursive Engine">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#compare_recursiveself-other-structuredmodel-dict" class="md-nav__link">
    <span class="md-ellipsis">
      compare_recursive(self, other: 'StructuredModel') -&gt; dict
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compare_recursive(self, other: &#39;StructuredModel&#39;) -&gt; dict">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#function-signature-and-purpose" class="md-nav__link">
    <span class="md-ellipsis">
      Function Signature and Purpose
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#internal-structure" class="md-nav__link">
    <span class="md-ellipsis">
      Internal Structure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-innovations" class="md-nav__link">
    <span class="md-ellipsis">
      Key Innovations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#processing-loop" class="md-nav__link">
    <span class="md-ellipsis">
      Processing Loop
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#final-score-calculation" class="md-nav__link">
    <span class="md-ellipsis">
      Final Score Calculation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#field-dispatch-system" class="md-nav__link">
    <span class="md-ellipsis">
      Field Dispatch System
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Field Dispatch System">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_dispatch_field_comparisonself-field_name-str-gt_val-any-pred_val-any-dict" class="md-nav__link">
    <span class="md-ellipsis">
      _dispatch_field_comparison(self, field_name: str, gt_val: Any, pred_val: Any) -&gt; dict
    </span>
  </a>
  
    <nav class="md-nav" aria-label="_dispatch_field_comparison(self, field_name: str, gt_val: Any, pred_val: Any) -&gt; dict">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#key-responsibilities" class="md-nav__link">
    <span class="md-ellipsis">
      Key Responsibilities
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#match-based-type-detection" class="md-nav__link">
    <span class="md-ellipsis">
      Match-Based Type Detection
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#list-field-dispatch-with-match-statements" class="md-nav__link">
    <span class="md-ellipsis">
      List Field Dispatch with Match Statements
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#primitive-null-handling" class="md-nav__link">
    <span class="md-ellipsis">
      Primitive Null Handling
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#type-based-handler-selection" class="md-nav__link">
    <span class="md-ellipsis">
      Type-Based Handler Selection
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#specialized-comparison-handlers" class="md-nav__link">
    <span class="md-ellipsis">
      Specialized Comparison Handlers
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Specialized Comparison Handlers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_compare_primitive_with_scoresself-gt_val-any-pred_val-any-field_name-str-dict" class="md-nav__link">
    <span class="md-ellipsis">
      _compare_primitive_with_scores(self, gt_val: Any, pred_val: Any, field_name: str) -&gt; dict
    </span>
  </a>
  
    <nav class="md-nav" aria-label="_compare_primitive_with_scores(self, gt_val: Any, pred_val: Any, field_name: str) -&gt; dict">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#key-features" class="md-nav__link">
    <span class="md-ellipsis">
      Key Features
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_compare_primitive_list_with_scoresself-gt_list-listany-pred_list-listany-field_name-str-dict" class="md-nav__link">
    <span class="md-ellipsis">
      _compare_primitive_list_with_scores(self, gt_list: List[Any], pred_list: List[Any], field_name: str) -&gt; dict
    </span>
  </a>
  
    <nav class="md-nav" aria-label="_compare_primitive_list_with_scores(self, gt_list: List[Any], pred_list: List[Any], field_name: str) -&gt; dict">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#critical-design-decision-universal-hierarchical-structure" class="md-nav__link">
    <span class="md-ellipsis">
      Critical Design Decision: Universal Hierarchical Structure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#emptynull-handling" class="md-nav__link">
    <span class="md-ellipsis">
      Empty/Null Handling
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hungarian-matching-integration" class="md-nav__link">
    <span class="md-ellipsis">
      Hungarian Matching Integration
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_compare_struct_list_with_scoresself-gt_list-liststructuredmodel-pred_list-liststructuredmodel-field_name-str-dict" class="md-nav__link">
    <span class="md-ellipsis">
      _compare_struct_list_with_scores(self, gt_list: List['StructuredModel'], pred_list: List['StructuredModel'], field_name: str) -&gt; dict
    </span>
  </a>
  
    <nav class="md-nav" aria-label="_compare_struct_list_with_scores(self, gt_list: List[&#39;StructuredModel&#39;], pred_list: List[&#39;StructuredModel&#39;], field_name: str) -&gt; dict">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#critical-design-principle-object-level-vs-field-level-separation" class="md-nav__link">
    <span class="md-ellipsis">
      Critical Design Principle: Object-Level vs Field-Level Separation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#empty-case-handling-with-match-statements" class="md-nav__link">
    <span class="md-ellipsis">
      Empty Case Handling with Match Statements
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#object-level-metrics-calculation" class="md-nav__link">
    <span class="md-ellipsis">
      Object-Level Metrics Calculation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#field-level-details-generation-threshold-gated-recursion" class="md-nav__link">
    <span class="md-ellipsis">
      Field-Level Details Generation (Threshold-Gated Recursion)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hungarian-matching-integration_1" class="md-nav__link">
    <span class="md-ellipsis">
      Hungarian Matching Integration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Hungarian Matching Integration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-_compare_unordered_lists-method" class="md-nav__link">
    <span class="md-ellipsis">
      The _compare_unordered_lists() Method
    </span>
  </a>
  
    <nav class="md-nav" aria-label="The _compare_unordered_lists() Method">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#key-algorithm-features" class="md-nav__link">
    <span class="md-ellipsis">
      Key Algorithm Features
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation Strategy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#threshold-based-classification" class="md-nav__link">
    <span class="md-ellipsis">
      Threshold-Based Classification
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#overall-score-calculation" class="md-nav__link">
    <span class="md-ellipsis">
      Overall Score Calculation
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#score-aggregation-and-percolation" class="md-nav__link">
    <span class="md-ellipsis">
      Score Aggregation and Percolation
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Score Aggregation and Percolation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-percolation-system" class="md-nav__link">
    <span class="md-ellipsis">
      The Percolation System
    </span>
  </a>
  
    <nav class="md-nav" aria-label="The Percolation System">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#score-types" class="md-nav__link">
    <span class="md-ellipsis">
      Score Types
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#weight-based-aggregation" class="md-nav__link">
    <span class="md-ellipsis">
      Weight-Based Aggregation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#all_fields_matched-determination" class="md-nav__link">
    <span class="md-ellipsis">
      all_fields_matched Determination
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#aggregation-helper-_aggregate_to_overall" class="md-nav__link">
    <span class="md-ellipsis">
      Aggregation Helper: _aggregate_to_overall()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#threshold-gated-recursion" class="md-nav__link">
    <span class="md-ellipsis">
      Threshold-Gated Recursion
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Threshold-Gated Recursion">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-optimization-strategy" class="md-nav__link">
    <span class="md-ellipsis">
      The Optimization Strategy
    </span>
  </a>
  
    <nav class="md-nav" aria-label="The Optimization Strategy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#implementation-in-list-processing" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation in List Processing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#benefits" class="md-nav__link">
    <span class="md-ellipsis">
      Benefits
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#performance-optimizations" class="md-nav__link">
    <span class="md-ellipsis">
      Performance Optimizations
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Performance Optimizations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#single-traversal-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Single Traversal Architecture
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lazy-evaluation" class="md-nav__link">
    <span class="md-ellipsis">
      Lazy Evaluation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#memory-efficiency" class="md-nav__link">
    <span class="md-ellipsis">
      Memory Efficiency
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hungarian-algorithm-optimization" class="md-nav__link">
    <span class="md-ellipsis">
      Hungarian Algorithm Optimization
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#debugging-and-troubleshooting" class="md-nav__link">
    <span class="md-ellipsis">
      Debugging and Troubleshooting
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Debugging and Troubleshooting">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#common-issues-and-solutions" class="md-nav__link">
    <span class="md-ellipsis">
      Common Issues and Solutions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Common Issues and Solutions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-incorrect-similarity-scores" class="md-nav__link">
    <span class="md-ellipsis">
      1. Incorrect Similarity Scores
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-confusion-matrix-inconsistencies" class="md-nav__link">
    <span class="md-ellipsis">
      2. Confusion Matrix Inconsistencies
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-performance-issues" class="md-nav__link">
    <span class="md-ellipsis">
      3. Performance Issues
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-memory-usage" class="md-nav__link">
    <span class="md-ellipsis">
      4. Memory Usage
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#debugging-helper-methods" class="md-nav__link">
    <span class="md-ellipsis">
      Debugging Helper Methods
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-complex-scenarios" class="md-nav__link">
    <span class="md-ellipsis">
      Testing Complex Scenarios
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#profiling-guidelines" class="md-nav__link">
    <span class="md-ellipsis">
      Profiling Guidelines
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-performance-metrics-to-monitor" class="md-nav__link">
    <span class="md-ellipsis">
      Key Performance Metrics to Monitor
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#code-maintenance-guidelines" class="md-nav__link">
    <span class="md-ellipsis">
      Code Maintenance Guidelines
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#conclusion" class="md-nav__link">
    <span class="md-ellipsis">
      Conclusion
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="structuredmodel-advanced-functionality-technical-deep-dive">StructuredModel Advanced Functionality: Technical Deep Dive</h1>
<h2 id="table-of-contents">Table of Contents</h2>
<ol>
<li><a href="#overview">Overview</a></li>
<li><a href="#core-recursive-engine">Core Recursive Engine</a></li>
<li><a href="#field-dispatch-system">Field Dispatch System</a></li>
<li><a href="#specialized-comparison-handlers">Specialized Comparison Handlers</a></li>
<li><a href="#hungarian-matching-integration">Hungarian Matching Integration</a></li>
<li><a href="#score-aggregation-and-percolation">Score Aggregation and Percolation</a></li>
<li><a href="#threshold-gated-recursion">Threshold-Gated Recursion</a></li>
<li><a href="#performance-optimizations">Performance Optimizations</a></li>
<li><a href="#debugging-and-troubleshooting">Debugging and Troubleshooting</a></li>
</ol>
<h2 id="overview">Overview</h2>
<p>This document provides a technical deep-dive into the core recursive logic of StructuredModel's comparison system. It's intended for developers who need to understand, modify, debug, or extend the complex internal functions that power the comparison engine.</p>
<p>The system is built around several "monster functions" that handle the complexity of comparing nested, heterogeneous data structures while maintaining both performance and accuracy.</p>
<h2 id="core-recursive-engine">Core Recursive Engine</h2>
<h3 id="compare_recursiveself-other-structuredmodel-dict"><code>compare_recursive(self, other: 'StructuredModel') -&gt; dict</code></h3>
<p>This is the heart of the comparison system - a single-traversal engine that gathers both similarity scores and confusion matrix data in one pass.</p>
<h4 id="function-signature-and-purpose">Function Signature and Purpose</h4>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compare_recursive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s1">&#39;StructuredModel&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The ONE clean recursive function that handles everything.</span>

<span class="sd">    Enhanced to capture BOTH confusion matrix metrics AND similarity scores</span>
<span class="sd">    in a single traversal to eliminate double traversal inefficiency.</span>
<span class="sd">    &quot;&quot;&quot;</span>
</code></pre></div>
<h4 id="internal-structure">Internal Structure</h4>
<div class="highlight"><pre><span></span><code><span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;overall&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;tp&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;fa&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;fd&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;fp&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;tn&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;fn&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;similarity_score&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="s2">&quot;all_fields_matched&quot;</span><span class="p">:</span> <span class="kc">False</span>
    <span class="p">},</span>
    <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">{},</span>
    <span class="s2">&quot;non_matches&quot;</span><span class="p">:</span> <span class="p">[]</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="key-innovations">Key Innovations</h4>
<ol>
<li>
<p><strong>Single Traversal Optimization</strong>: Instead of multiple passes through the object structure, all data gathering happens in one recursive descent.</p>
</li>
<li>
<p><strong>Dual-Purpose Processing</strong>: Each field comparison returns both:</p>
</li>
<li>Confusion matrix metrics (TP, FP, FN, etc.)</li>
<li>
<p>Similarity scores for aggregation</p>
</li>
<li>
<p><strong>Score Percolation Variables</strong>:
   <div class="highlight"><pre><span></span><code><span class="n">total_score</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">total_weight</span> <span class="o">=</span> <span class="mf">0.0</span>  
<span class="n">threshold_matched_fields</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</code></pre></div></p>
</li>
</ol>
<h4 id="processing-loop">Processing Loop</h4>
<div class="highlight"><pre><span></span><code><span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">model_fields</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">field_name</span> <span class="o">==</span> <span class="s1">&#39;extra_fields&#39;</span><span class="p">:</span>
        <span class="k">continue</span>

    <span class="n">gt_val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span>
    <span class="n">pred_val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># Enhanced dispatch returns both metrics AND scores</span>
    <span class="n">field_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dispatch_field_comparison</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">gt_val</span><span class="p">,</span> <span class="n">pred_val</span><span class="p">)</span>

    <span class="n">result</span><span class="p">[</span><span class="s2">&quot;fields&quot;</span><span class="p">][</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_result</span>

    <span class="c1"># Simple aggregation to overall metrics</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_aggregate_to_overall</span><span class="p">(</span><span class="n">field_result</span><span class="p">,</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;overall&quot;</span><span class="p">])</span>

    <span class="c1"># Score percolation - aggregate scores upward</span>
    <span class="k">if</span> <span class="s2">&quot;similarity_score&quot;</span> <span class="ow">in</span> <span class="n">field_result</span> <span class="ow">and</span> <span class="s2">&quot;weight&quot;</span> <span class="ow">in</span> <span class="n">field_result</span><span class="p">:</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="n">field_result</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span>
        <span class="n">threshold_applied_score</span> <span class="o">=</span> <span class="n">field_result</span><span class="p">[</span><span class="s2">&quot;threshold_applied_score&quot;</span><span class="p">]</span>
        <span class="n">total_score</span> <span class="o">+=</span> <span class="n">threshold_applied_score</span> <span class="o">*</span> <span class="n">weight</span>
        <span class="n">total_weight</span> <span class="o">+=</span> <span class="n">weight</span>

        <span class="c1"># Track threshold-matched fields</span>
        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_comparison_info</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">field_result</span><span class="p">[</span><span class="s2">&quot;raw_similarity_score&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">info</span><span class="o">.</span><span class="n">threshold</span><span class="p">:</span>
            <span class="n">threshold_matched_fields</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
</code></pre></div>
<h4 id="final-score-calculation">Final Score Calculation</h4>
<div class="highlight"><pre><span></span><code><span class="c1"># Calculate overall similarity score from percolated scores</span>
<span class="k">if</span> <span class="n">total_weight</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">result</span><span class="p">[</span><span class="s2">&quot;overall&quot;</span><span class="p">][</span><span class="s2">&quot;similarity_score&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_score</span> <span class="o">/</span> <span class="n">total_weight</span>

<span class="c1"># Determine all_fields_matched</span>
<span class="n">model_fields_for_comparison</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">model_fields</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="p">{</span><span class="s1">&#39;extra_fields&#39;</span><span class="p">}</span>
<span class="n">result</span><span class="p">[</span><span class="s2">&quot;overall&quot;</span><span class="p">][</span><span class="s2">&quot;all_fields_matched&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">threshold_matched_fields</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_fields_for_comparison</span><span class="p">)</span>
</code></pre></div>
<h2 id="field-dispatch-system">Field Dispatch System</h2>
<h3 id="_dispatch_field_comparisonself-field_name-str-gt_val-any-pred_val-any-dict"><code>_dispatch_field_comparison(self, field_name: str, gt_val: Any, pred_val: Any) -&gt; dict</code></h3>
<p>This function routes each field to the appropriate comparison handler based on its type and content. It uses Python's <code>match</code> statements for clean, efficient dispatch.</p>
<h4 id="key-responsibilities">Key Responsibilities</h4>
<ol>
<li><strong>Type Detection</strong>: Determines field type (primitive, list, nested object)</li>
<li><strong>Null Handling</strong>: Manages various null/empty states</li>
<li><strong>Configuration Retrieval</strong>: Gets field-specific comparison settings</li>
<li><strong>Handler Routing</strong>: Dispatches to appropriate specialized handler</li>
</ol>
<h4 id="match-based-type-detection">Match-Based Type Detection</h4>
<div class="highlight"><pre><span></span><code><span class="c1"># Get field configuration for scoring</span>
<span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_comparison_info</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
<span class="n">weight</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">weight</span>
<span class="n">threshold</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">threshold</span>

<span class="c1"># Check if this field is ANY list type</span>
<span class="n">is_list_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_list_field</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>

<span class="c1"># Get null states and hierarchical needs</span>
<span class="n">gt_is_null</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_truly_null</span><span class="p">(</span><span class="n">gt_val</span><span class="p">)</span>
<span class="n">pred_is_null</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_truly_null</span><span class="p">(</span><span class="n">pred_val</span><span class="p">)</span>
<span class="n">gt_needs_hierarchy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_use_hierarchical_structure</span><span class="p">(</span><span class="n">gt_val</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span>
<span class="n">pred_needs_hierarchy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_use_hierarchical_structure</span><span class="p">(</span><span class="n">pred_val</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span>
</code></pre></div>
<h4 id="list-field-dispatch-with-match-statements">List Field Dispatch with Match Statements</h4>
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="n">is_list_field</span><span class="p">:</span>
    <span class="n">list_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_list_field_dispatch</span><span class="p">(</span><span class="n">gt_val</span><span class="p">,</span> <span class="n">pred_val</span><span class="p">,</span> <span class="n">weight</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">list_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">list_result</span>
</code></pre></div>
<h4 id="primitive-null-handling">Primitive Null Handling</h4>
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">gt_needs_hierarchy</span> <span class="ow">or</span> <span class="n">pred_needs_hierarchy</span><span class="p">):</span>
    <span class="n">gt_effectively_null_prim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_effectively_null_for_primitives</span><span class="p">(</span><span class="n">gt_val</span><span class="p">)</span>
    <span class="n">pred_effectively_null_prim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_effectively_null_for_primitives</span><span class="p">(</span><span class="n">pred_val</span><span class="p">)</span>

    <span class="k">match</span> <span class="p">(</span><span class="n">gt_effectively_null_prim</span><span class="p">,</span> <span class="n">pred_effectively_null_prim</span><span class="p">):</span>
        <span class="k">case</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_true_negative_result</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>
        <span class="k">case</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_false_alarm_result</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>
        <span class="k">case</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_false_negative_result</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>
        <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
            <span class="c1"># Both non-null, continue to type-based dispatch</span>
            <span class="k">pass</span>
</code></pre></div>
<h4 id="type-based-handler-selection">Type-Based Handler Selection</h4>
<div class="highlight"><pre><span></span><code><span class="c1"># Type-based dispatch</span>
<span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gt_val</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pred_val</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compare_primitive_with_scores</span><span class="p">(</span><span class="n">gt_val</span><span class="p">,</span> <span class="n">pred_val</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span>
<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gt_val</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pred_val</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
    <span class="c1"># Check if this should be structured list</span>
    <span class="k">if</span> <span class="n">gt_val</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gt_val</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">StructuredModel</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compare_struct_list_with_scores</span><span class="p">(</span><span class="n">gt_val</span><span class="p">,</span> <span class="n">pred_val</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compare_primitive_list_with_scores</span><span class="p">(</span><span class="n">gt_val</span><span class="p">,</span> <span class="n">pred_val</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span>
<span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gt_val</span><span class="p">,</span> <span class="n">StructuredModel</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pred_val</span><span class="p">,</span> <span class="n">StructuredModel</span><span class="p">):</span>
    <span class="c1"># For recursive StructuredModel comparison</span>
    <span class="n">recursive_result</span> <span class="o">=</span> <span class="n">gt_val</span><span class="o">.</span><span class="n">compare_recursive</span><span class="p">(</span><span class="n">pred_val</span><span class="p">)</span>  <span class="c1"># PURE RECURSION</span>

    <span class="c1"># Add scoring information to the recursive result</span>
    <span class="n">raw_score</span> <span class="o">=</span> <span class="n">recursive_result</span><span class="p">[</span><span class="s2">&quot;overall&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;similarity_score&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="n">threshold_applied_score</span> <span class="o">=</span> <span class="n">raw_score</span> <span class="k">if</span> <span class="n">raw_score</span> <span class="o">&gt;=</span> <span class="n">threshold</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">info</span><span class="o">.</span><span class="n">clip_under_threshold</span> <span class="k">else</span> <span class="mf">0.0</span>

    <span class="n">recursive_result</span><span class="p">[</span><span class="s2">&quot;raw_similarity_score&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw_score</span>
    <span class="n">recursive_result</span><span class="p">[</span><span class="s2">&quot;similarity_score&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw_score</span>
    <span class="n">recursive_result</span><span class="p">[</span><span class="s2">&quot;threshold_applied_score&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">threshold_applied_score</span>
    <span class="n">recursive_result</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">weight</span>

    <span class="k">return</span> <span class="n">recursive_result</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># Mismatched types</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;overall&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;tp&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;fa&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;fd&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;fp&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;tn&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;fn&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
        <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s2">&quot;raw_similarity_score&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="s2">&quot;similarity_score&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="s2">&quot;threshold_applied_score&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="n">weight</span>
    <span class="p">}</span>
</code></pre></div>
<h2 id="specialized-comparison-handlers">Specialized Comparison Handlers</h2>
<h3 id="_compare_primitive_with_scoresself-gt_val-any-pred_val-any-field_name-str-dict"><code>_compare_primitive_with_scores(self, gt_val: Any, pred_val: Any, field_name: str) -&gt; dict</code></h3>
<p>Handles simple field comparisons (strings, numbers, dates) with integrated scoring and metrics.</p>
<h4 id="key-features">Key Features</h4>
<ol>
<li><strong>Comparator Application</strong>: Uses configured comparator (Levenshtein, exact, etc.)</li>
<li><strong>Threshold-Based Classification</strong>: Converts similarity to binary metrics</li>
<li><strong>Configurable Clipping</strong>: Respects <code>clip_under_threshold</code> settings</li>
</ol>
<h4 id="implementation">Implementation</h4>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_compare_primitive_with_scores</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gt_val</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">pred_val</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">_get_comparison_info</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
    <span class="n">raw_similarity</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">comparator</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="n">gt_val</span><span class="p">,</span> <span class="n">pred_val</span><span class="p">)</span>
    <span class="n">weight</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">weight</span>
    <span class="n">threshold</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">threshold</span>

    <span class="c1"># For binary classification metrics, always use threshold</span>
    <span class="k">if</span> <span class="n">raw_similarity</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">:</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;tp&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;fa&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;fd&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;fp&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;tn&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;fn&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
        <span class="n">threshold_applied_score</span> <span class="o">=</span> <span class="n">raw_similarity</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;tp&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;fa&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;fd&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;fp&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;tn&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;fn&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
        <span class="c1"># For score calculation, respect clip_under_threshold setting</span>
        <span class="n">threshold_applied_score</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">clip_under_threshold</span> <span class="k">else</span> <span class="n">raw_similarity</span>

    <span class="c1"># Return hierarchical structure for consistency</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;overall&quot;</span><span class="p">:</span> <span class="n">metrics</span><span class="p">,</span>
        <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="s2">&quot;raw_similarity_score&quot;</span><span class="p">:</span> <span class="n">raw_similarity</span><span class="p">,</span>
        <span class="s2">&quot;similarity_score&quot;</span><span class="p">:</span> <span class="n">raw_similarity</span><span class="p">,</span>
        <span class="s2">&quot;threshold_applied_score&quot;</span><span class="p">:</span> <span class="n">threshold_applied_score</span><span class="p">,</span>
        <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="n">weight</span>
    <span class="p">}</span>
</code></pre></div>
<h3 id="_compare_primitive_list_with_scoresself-gt_list-listany-pred_list-listany-field_name-str-dict"><code>_compare_primitive_list_with_scores(self, gt_list: List[Any], pred_list: List[Any], field_name: str) -&gt; dict</code></h3>
<p>Handles lists of primitive values (strings, numbers) using Hungarian matching.</p>
<h4 id="critical-design-decision-universal-hierarchical-structure">Critical Design Decision: Universal Hierarchical Structure</h4>
<p>This method returns a hierarchical structure <code>{"overall": {...}, "fields": {...}}</code> even for primitive lists to maintain API consistency across all field types.</p>
<p><strong>Rationale:</strong>
- <strong>Consistency</strong>: All list fields use the same access pattern: <code>cm["fields"][name]["overall"]</code>
- <strong>Test Compatibility</strong>: Multiple test files expect this pattern for both primitive and structured lists
- <strong>Predictable API</strong>: Consumers don't need to check field type before accessing metrics</p>
<h4 id="emptynull-handling">Empty/Null Handling</h4>
<div class="highlight"><pre><span></span><code><span class="c1"># CRITICAL FIX: Handle None values before checking length</span>
<span class="k">if</span> <span class="n">gt_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">gt_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">if</span> <span class="n">pred_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">pred_list</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Handle empty/null list cases first - FIXED: Empty lists should be TN=1</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gt_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="c1"># Both empty lists should be TN=1</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;overall&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;tp&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;fa&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;fd&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;fp&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;tn&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;fn&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
        <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">{},</span>  <span class="c1"># Empty for primitive lists</span>
        <span class="s2">&quot;raw_similarity_score&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>  <span class="c1"># Perfect match</span>
        <span class="s2">&quot;similarity_score&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="s2">&quot;threshold_applied_score&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="n">weight</span>
    <span class="p">}</span>
</code></pre></div>
<h4 id="hungarian-matching-integration">Hungarian Matching Integration</h4>
<div class="highlight"><pre><span></span><code><span class="c1"># For primitive lists, use the comparison logic from _compare_unordered_lists</span>
<span class="n">comparator</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">comparator</span>
<span class="n">match_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compare_unordered_lists</span><span class="p">(</span><span class="n">gt_list</span><span class="p">,</span> <span class="n">pred_list</span><span class="p">,</span> <span class="n">comparator</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span>

<span class="c1"># Extract the counts from the match result</span>
<span class="n">tp</span> <span class="o">=</span> <span class="n">match_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tp&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">fd</span> <span class="o">=</span> <span class="n">match_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fd&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> 
<span class="n">fa</span> <span class="o">=</span> <span class="n">match_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fa&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">fn</span> <span class="o">=</span> <span class="n">match_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fn&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># Use the overall_score from the match result for raw similarity</span>
<span class="n">raw_similarity</span> <span class="o">=</span> <span class="n">match_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;overall_score&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

<span class="c1"># CRITICAL FIX: For lists, we NEVER clip under threshold - partial matches are important</span>
<span class="n">threshold_applied_score</span> <span class="o">=</span> <span class="n">raw_similarity</span>  <span class="c1"># Always use raw score for lists</span>
</code></pre></div>
<h3 id="_compare_struct_list_with_scoresself-gt_list-liststructuredmodel-pred_list-liststructuredmodel-field_name-str-dict"><code>_compare_struct_list_with_scores(self, gt_list: List['StructuredModel'], pred_list: List['StructuredModel'], field_name: str) -&gt; dict</code></h3>
<p>This is the most complex handler, dealing with lists of structured objects. It implements sophisticated object-level and field-level analysis.</p>
<h4 id="critical-design-principle-object-level-vs-field-level-separation">Critical Design Principle: Object-Level vs Field-Level Separation</h4>
<ul>
<li><strong>List-level metrics count OBJECTS, not individual fields</strong></li>
<li><strong>Field-level details are kept separate for hierarchical analysis</strong></li>
<li>Tests expect <code>TP=3</code> for 3 matched objects, not <code>TP=9</code> for 3 objects  3 fields each</li>
</ul>
<h4 id="empty-case-handling-with-match-statements">Empty Case Handling with Match Statements</h4>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_handle_struct_list_empty_cases</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gt_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="s1">&#39;StructuredModel&#39;</span><span class="p">],</span> <span class="n">pred_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="s1">&#39;StructuredModel&#39;</span><span class="p">],</span> <span class="n">weight</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="c1"># Normalize None to empty lists for consistent handling</span>
    <span class="n">gt_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gt_list</span> <span class="ow">or</span> <span class="p">[])</span>
    <span class="n">pred_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred_list</span> <span class="ow">or</span> <span class="p">[])</span>

    <span class="k">match</span> <span class="p">(</span><span class="n">gt_len</span><span class="p">,</span> <span class="n">pred_len</span><span class="p">):</span>
        <span class="k">case</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="c1"># Both empty lists  True Negative</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;overall&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;tp&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;fa&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;fd&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;fp&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;tn&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;fn&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
                <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">{},</span>
                <span class="s2">&quot;raw_similarity_score&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                <span class="s2">&quot;similarity_score&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                <span class="s2">&quot;threshold_applied_score&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="n">weight</span>
            <span class="p">}</span>
        <span class="k">case</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pred_len</span><span class="p">):</span>
            <span class="c1"># GT empty, pred has items  False Alarms</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;overall&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;tp&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;fa&quot;</span><span class="p">:</span> <span class="n">pred_len</span><span class="p">,</span> <span class="s2">&quot;fd&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;fp&quot;</span><span class="p">:</span> <span class="n">pred_len</span><span class="p">,</span> <span class="s2">&quot;tn&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;fn&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
                <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">{},</span>
                <span class="s2">&quot;raw_similarity_score&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s2">&quot;similarity_score&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s2">&quot;threshold_applied_score&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="n">weight</span>
            <span class="p">}</span>
        <span class="k">case</span> <span class="p">(</span><span class="n">gt_len</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="c1"># GT has items, pred empty  False Negatives</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;overall&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;tp&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;fa&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;fd&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;fp&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;tn&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;fn&quot;</span><span class="p">:</span> <span class="n">gt_len</span><span class="p">},</span>
                <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">{},</span>
                <span class="s2">&quot;raw_similarity_score&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s2">&quot;similarity_score&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s2">&quot;threshold_applied_score&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="n">weight</span>
            <span class="p">}</span>
        <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
            <span class="c1"># Both non-empty, continue processing</span>
            <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>
<h4 id="object-level-metrics-calculation">Object-Level Metrics Calculation</h4>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_calculate_object_level_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gt_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="s1">&#39;StructuredModel&#39;</span><span class="p">],</span> <span class="n">pred_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="s1">&#39;StructuredModel&#39;</span><span class="p">],</span> <span class="n">match_threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
    <span class="c1"># Use Hungarian matching for OBJECT-LEVEL counts</span>
    <span class="n">hungarian_helper</span> <span class="o">=</span> <span class="n">HungarianHelper</span><span class="p">()</span>
    <span class="n">matched_pairs</span> <span class="o">=</span> <span class="n">hungarian_helper</span><span class="o">.</span><span class="n">get_matched_pairs_with_scores</span><span class="p">(</span><span class="n">gt_list</span><span class="p">,</span> <span class="n">pred_list</span><span class="p">)</span>

    <span class="c1"># Count OBJECTS, not individual fields</span>
    <span class="n">tp_objects</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Objects with similarity &gt;= match_threshold</span>
    <span class="n">fd_objects</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Objects with similarity &lt; match_threshold</span>
    <span class="k">for</span> <span class="n">gt_idx</span><span class="p">,</span> <span class="n">pred_idx</span><span class="p">,</span> <span class="n">similarity</span> <span class="ow">in</span> <span class="n">matched_pairs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">similarity</span> <span class="o">&gt;=</span> <span class="n">match_threshold</span><span class="p">:</span>
            <span class="n">tp_objects</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fd_objects</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># Count unmatched objects</span>
    <span class="n">matched_gt_indices</span> <span class="o">=</span> <span class="p">{</span><span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">matched_pairs</span><span class="p">}</span>
    <span class="n">matched_pred_indices</span> <span class="o">=</span> <span class="p">{</span><span class="n">idx</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">matched_pairs</span><span class="p">}</span>
    <span class="n">fn_objects</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gt_list</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">matched_gt_indices</span><span class="p">)</span>  <span class="c1"># Unmatched GT objects</span>
    <span class="n">fa_objects</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred_list</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">matched_pred_indices</span><span class="p">)</span>  <span class="c1"># Unmatched pred objects</span>

    <span class="c1"># Build list-level metrics counting OBJECTS (not fields)</span>
    <span class="n">object_level_metrics</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;tp&quot;</span><span class="p">:</span> <span class="n">tp_objects</span><span class="p">,</span>
        <span class="s2">&quot;fa&quot;</span><span class="p">:</span> <span class="n">fa_objects</span><span class="p">,</span>  
        <span class="s2">&quot;fd&quot;</span><span class="p">:</span> <span class="n">fd_objects</span><span class="p">,</span>
        <span class="s2">&quot;fp&quot;</span><span class="p">:</span> <span class="n">fa_objects</span> <span class="o">+</span> <span class="n">fd_objects</span><span class="p">,</span>  <span class="c1"># Total false positives</span>
        <span class="s2">&quot;tn&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># No true negatives at object level for non-empty lists</span>
        <span class="s2">&quot;fn&quot;</span><span class="p">:</span> <span class="n">fn_objects</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">object_level_metrics</span><span class="p">,</span> <span class="n">matched_pairs</span><span class="p">,</span> <span class="n">matched_gt_indices</span><span class="p">,</span> <span class="n">matched_pred_indices</span>
</code></pre></div>
<h4 id="field-level-details-generation-threshold-gated-recursion">Field-Level Details Generation (Threshold-Gated Recursion)</h4>
<p>The system only generates detailed field analysis for object pairs that meet the similarity threshold. This is a key performance optimization.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Get field-level details for nested structure (but DON&#39;T aggregate to list level)</span>
<span class="c1"># THRESHOLD-GATED RECURSION: Only generate field details for good matches</span>
<span class="n">field_details</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">if</span> <span class="n">gt_list</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gt_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">StructuredModel</span><span class="p">):</span>
    <span class="n">model_class</span> <span class="o">=</span> <span class="n">gt_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__class__</span>

    <span class="c1"># Only create field structure if we have good matches (&gt;= match_threshold)</span>
    <span class="n">has_good_matches</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">sim</span> <span class="o">&gt;=</span> <span class="n">match_threshold</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">sim</span> <span class="ow">in</span> <span class="n">matched_pairs</span><span class="p">)</span>
    <span class="n">has_unmatched</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">matched_gt_indices</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">gt_list</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">matched_pred_indices</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred_list</span><span class="p">))</span>

    <span class="c1"># Only generate field details if we have good matches OR unmatched objects</span>
    <span class="k">if</span> <span class="n">has_good_matches</span> <span class="ow">or</span> <span class="n">has_unmatched</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">sub_field_name</span> <span class="ow">in</span> <span class="n">model_class</span><span class="o">.</span><span class="n">model_fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sub_field_name</span> <span class="o">==</span> <span class="s1">&#39;extra_fields&#39;</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Check if this field is a List[StructuredModel] that needs hierarchical treatment</span>
            <span class="n">field_info</span> <span class="o">=</span> <span class="n">model_class</span><span class="o">.</span><span class="n">model_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sub_field_name</span><span class="p">)</span>
            <span class="n">is_hierarchical_field</span> <span class="o">=</span> <span class="p">(</span><span class="n">field_info</span> <span class="ow">and</span> <span class="n">model_class</span><span class="o">.</span><span class="n">_is_structured_field_type</span><span class="p">(</span><span class="n">field_info</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">is_hierarchical_field</span><span class="p">:</span>
                <span class="c1"># Handle nested List[StructuredModel] fields with aggregation across matched pairs</span>
                <span class="c1"># ... [complex hierarchical processing logic]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Handle primitive fields - aggregate across all matched objects</span>
                <span class="n">sub_field_metrics</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;tp&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;fa&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;fd&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;fp&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;tn&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;fn&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

                <span class="c1"># THRESHOLD-GATED: Only process matched pairs above match_threshold</span>
                <span class="k">for</span> <span class="n">gt_idx</span><span class="p">,</span> <span class="n">pred_idx</span><span class="p">,</span> <span class="n">similarity</span> <span class="ow">in</span> <span class="n">matched_pairs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">similarity</span> <span class="o">&gt;=</span> <span class="n">match_threshold</span> <span class="ow">and</span> <span class="n">gt_idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">gt_list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pred_idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred_list</span><span class="p">):</span>
                        <span class="n">gt_item</span> <span class="o">=</span> <span class="n">gt_list</span><span class="p">[</span><span class="n">gt_idx</span><span class="p">]</span>
                        <span class="n">pred_item</span> <span class="o">=</span> <span class="n">pred_list</span><span class="p">[</span><span class="n">pred_idx</span><span class="p">]</span>
                        <span class="n">gt_sub_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">gt_item</span><span class="p">,</span> <span class="n">sub_field_name</span><span class="p">)</span>
                        <span class="n">pred_sub_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">pred_item</span><span class="p">,</span> <span class="n">sub_field_name</span><span class="p">)</span>

                        <span class="c1"># Regular field - use flat classification</span>
                        <span class="n">field_classification</span> <span class="o">=</span> <span class="n">gt_item</span><span class="o">.</span><span class="n">_classify_field_for_confusion_matrix</span><span class="p">(</span><span class="n">sub_field_name</span><span class="p">,</span> <span class="n">pred_sub_value</span><span class="p">)</span>

                        <span class="c1"># Aggregate field metrics across all objects</span>
                        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;tp&quot;</span><span class="p">,</span> <span class="s2">&quot;fa&quot;</span><span class="p">,</span> <span class="s2">&quot;fd&quot;</span><span class="p">,</span> <span class="s2">&quot;fp&quot;</span><span class="p">,</span> <span class="s2">&quot;tn&quot;</span><span class="p">,</span> <span class="s2">&quot;fn&quot;</span><span class="p">]:</span>
                            <span class="n">sub_field_metrics</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">+=</span> <span class="n">field_classification</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</code></pre></div>
<h2 id="hungarian-matching-integration_1">Hungarian Matching Integration</h2>
<h3 id="the-_compare_unordered_lists-method">The <code>_compare_unordered_lists()</code> Method</h3>
<p>This method implements the core Hungarian matching algorithm through the <code>HungarianHelper</code> and <code>ComparisonHelper</code> classes.</p>
<h4 id="key-algorithm-features">Key Algorithm Features</h4>
<ol>
<li><strong>Optimal Bipartite Matching</strong>: Finds the best possible pairing between lists</li>
<li><strong>Similarity-Based</strong>: Uses actual similarity scores, not just binary match/no-match</li>
<li><strong>Handles Unequal Lengths</strong>: Gracefully manages lists of different sizes</li>
<li><strong>Threshold-Based Classification</strong>: Separates matches from false discoveries</li>
</ol>
<h4 id="implementation-strategy">Implementation Strategy</h4>
<div class="highlight"><pre><span></span><code><span class="c1"># Use HungarianHelper for Hungarian matching operations</span>
<span class="n">hungarian_helper</span> <span class="o">=</span> <span class="n">HungarianHelper</span><span class="p">()</span>

<span class="c1"># Use the appropriate comparator based on item types</span>
<span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">StructuredModel</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">list1</span><span class="p">[:</span><span class="mi">1</span><span class="p">])</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">StructuredModel</span><span class="p">)</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">list2</span><span class="p">[:</span><span class="mi">1</span><span class="p">]):</span>
    <span class="c1"># For StructuredModel lists, use match_threshold for object-level classification</span>
    <span class="n">model_class</span> <span class="o">=</span> <span class="n">list1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__class__</span>
    <span class="n">match_threshold</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="s1">&#39;match_threshold&#39;</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">)</span>
    <span class="n">classification_threshold</span> <span class="o">=</span> <span class="n">match_threshold</span>

    <span class="c1"># Use HungarianHelper for StructuredModel matching</span>
    <span class="n">matched_pairs</span> <span class="o">=</span> <span class="n">hungarian_helper</span><span class="o">.</span><span class="n">get_matched_pairs_with_scores</span><span class="p">(</span><span class="n">list1</span><span class="p">,</span> <span class="n">list2</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># Use the provided comparator for other types</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">stickler.algorithms.hungarian</span><span class="w"> </span><span class="kn">import</span> <span class="n">HungarianMatcher</span>
    <span class="c1"># Use match_threshold=0.0 to capture ALL matches, not just those above threshold</span>
    <span class="n">hungarian</span> <span class="o">=</span> <span class="n">HungarianMatcher</span><span class="p">(</span><span class="n">comparator</span><span class="p">,</span> <span class="n">match_threshold</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
    <span class="n">classification_threshold</span> <span class="o">=</span> <span class="n">threshold</span>

    <span class="c1"># Get detailed metrics from HungarianMatcher</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="n">hungarian</span><span class="o">.</span><span class="n">calculate_metrics</span><span class="p">(</span><span class="n">list1</span><span class="p">,</span> <span class="n">list2</span><span class="p">)</span>
    <span class="n">matched_pairs</span> <span class="o">=</span> <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;matched_pairs&quot;</span><span class="p">]</span>
</code></pre></div>
<h4 id="threshold-based-classification">Threshold-Based Classification</h4>
<div class="highlight"><pre><span></span><code><span class="c1"># Apply threshold logic to classify matches</span>
<span class="n">tp</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># True positives (score &gt;= threshold)</span>
<span class="n">fd</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># False discoveries (score &lt; threshold, including 0)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">matched_pairs</span><span class="p">:</span>
    <span class="c1"># Use ThresholdHelper for consistent threshold checking</span>
    <span class="k">if</span> <span class="n">ThresholdHelper</span><span class="o">.</span><span class="n">is_above_threshold</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">classification_threshold</span><span class="p">):</span>
        <span class="n">tp</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># All matches below threshold are False Discoveries, including 0.0 scores</span>
        <span class="n">fd</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="c1"># False alarms are unmatched prediction items</span>
<span class="n">fa</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">list2</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">matched_pairs</span><span class="p">)</span>

<span class="c1"># False negatives are unmatched ground truth items  </span>
<span class="n">fn</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">list1</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">matched_pairs</span><span class="p">)</span>

<span class="c1"># Total false positives include both false discoveries and false alarms</span>
<span class="n">fp</span> <span class="o">=</span> <span class="n">fd</span> <span class="o">+</span> <span class="n">fa</span>
</code></pre></div>
<h4 id="overall-score-calculation">Overall Score Calculation</h4>
<div class="highlight"><pre><span></span><code><span class="c1"># Calculate overall score considering ALL similarities, not just those above threshold</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">matched_pairs</span><span class="p">:</span>
    <span class="n">overall_score</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># Average similarity across all matched pairs (regardless of threshold)</span>
    <span class="n">total_similarity</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">score</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">score</span> <span class="ow">in</span> <span class="n">matched_pairs</span><span class="p">)</span>
    <span class="n">avg_similarity</span> <span class="o">=</span> <span class="n">total_similarity</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">matched_pairs</span><span class="p">)</span>

    <span class="c1"># Scale by coverage ratio (matched pairs / max list size)</span>
    <span class="n">max_items</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">list1</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">list2</span><span class="p">))</span>
    <span class="n">coverage_ratio</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">matched_pairs</span><span class="p">)</span> <span class="o">/</span> <span class="n">max_items</span> <span class="k">if</span> <span class="n">max_items</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">1.0</span>
    <span class="n">overall_score</span> <span class="o">=</span> <span class="n">avg_similarity</span> <span class="o">*</span> <span class="n">coverage_ratio</span>
</code></pre></div>
<h2 id="score-aggregation-and-percolation">Score Aggregation and Percolation</h2>
<h3 id="the-percolation-system">The Percolation System</h3>
<p>The system uses a "percolation" approach where scores bubble up from leaf fields to parent objects, eventually reaching the top-level overall score.</p>
<h4 id="score-types">Score Types</h4>
<ol>
<li><strong>Raw Similarity Score</strong>: Direct output from comparators (0.0 to 1.0)</li>
<li><strong>Similarity Score</strong>: Same as raw score, maintained for consistency</li>
<li><strong>Threshold Applied Score</strong>: Raw score with threshold clipping applied based on <code>clip_under_threshold</code> setting</li>
</ol>
<h4 id="weight-based-aggregation">Weight-Based Aggregation</h4>
<div class="highlight"><pre><span></span><code><span class="c1"># Score percolation variables</span>
<span class="n">total_score</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">total_weight</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">threshold_matched_fields</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

<span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">model_fields</span><span class="p">:</span>
    <span class="c1"># ... field processing ...</span>

    <span class="c1"># Score percolation - aggregate scores upward</span>
    <span class="k">if</span> <span class="s2">&quot;similarity_score&quot;</span> <span class="ow">in</span> <span class="n">field_result</span> <span class="ow">and</span> <span class="s2">&quot;weight&quot;</span> <span class="ow">in</span> <span class="n">field_result</span><span class="p">:</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="n">field_result</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span>
        <span class="n">threshold_applied_score</span> <span class="o">=</span> <span class="n">field_result</span><span class="p">[</span><span class="s2">&quot;threshold_applied_score&quot;</span><span class="p">]</span>
        <span class="n">total_score</span> <span class="o">+=</span> <span class="n">threshold_applied_score</span> <span class="o">*</span> <span class="n">weight</span>
        <span class="n">total_weight</span> <span class="o">+=</span> <span class="n">weight</span>

        <span class="c1"># Track threshold-matched fields</span>
        <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_comparison_info</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">field_result</span><span class="p">[</span><span class="s2">&quot;raw_similarity_score&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">info</span><span class="o">.</span><span class="n">threshold</span><span class="p">:</span>
            <span class="n">threshold_matched_fields</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>

<span class="c1"># Calculate overall similarity score from percolated scores</span>
<span class="k">if</span> <span class="n">total_weight</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">result</span><span class="p">[</span><span class="s2">&quot;overall&quot;</span><span class="p">][</span><span class="s2">&quot;similarity_score&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_score</span> <span class="o">/</span> <span class="n">total_weight</span>
</code></pre></div>
<h4 id="all_fields_matched-determination"><code>all_fields_matched</code> Determination</h4>
<div class="highlight"><pre><span></span><code><span class="c1"># Determine all_fields_matched</span>
<span class="n">model_fields_for_comparison</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">model_fields</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="p">{</span><span class="s1">&#39;extra_fields&#39;</span><span class="p">}</span>
<span class="n">result</span><span class="p">[</span><span class="s2">&quot;overall&quot;</span><span class="p">][</span><span class="s2">&quot;all_fields_matched&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">threshold_matched_fields</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_fields_for_comparison</span><span class="p">)</span>
</code></pre></div>
<h3 id="aggregation-helper-_aggregate_to_overall">Aggregation Helper: <code>_aggregate_to_overall()</code></h3>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_aggregate_to_overall</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_result</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">overall</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simple aggregation to overall metrics.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;tp&quot;</span><span class="p">,</span> <span class="s2">&quot;fa&quot;</span><span class="p">,</span> <span class="s2">&quot;fd&quot;</span><span class="p">,</span> <span class="s2">&quot;fp&quot;</span><span class="p">,</span> <span class="s2">&quot;tn&quot;</span><span class="p">,</span> <span class="s2">&quot;fn&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field_result</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">field_result</span><span class="p">:</span>
                <span class="n">overall</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">+=</span> <span class="n">field_result</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s2">&quot;overall&quot;</span> <span class="ow">in</span> <span class="n">field_result</span> <span class="ow">and</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">field_result</span><span class="p">[</span><span class="s2">&quot;overall&quot;</span><span class="p">]:</span>
                <span class="n">overall</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="o">+=</span> <span class="n">field_result</span><span class="p">[</span><span class="s2">&quot;overall&quot;</span><span class="p">][</span><span class="n">metric</span><span class="p">]</span>
</code></pre></div>
<h2 id="threshold-gated-recursion">Threshold-Gated Recursion</h2>
<h3 id="the-optimization-strategy">The Optimization Strategy</h3>
<p>For performance reasons, the system only performs detailed recursive analysis on object pairs that meet a minimum similarity threshold. Poor matches are treated as atomic failures.</p>
<h4 id="implementation-in-list-processing">Implementation in List Processing</h4>
<div class="highlight"><pre><span></span><code><span class="c1"># THRESHOLD-GATED RECURSION: Only perform recursive field analysis for object pairs</span>
<span class="c1"># with similarity &gt;= StructuredModel.match_threshold. Poor matches and unmatched </span>
<span class="c1"># items are treated as atomic units.</span>

<span class="n">match_threshold</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="s1">&#39;match_threshold&#39;</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">)</span>

<span class="c1"># For each field in the nested model</span>
<span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">model_class</span><span class="o">.</span><span class="n">model_fields</span><span class="p">:</span>
    <span class="c1"># ... initialization ...</span>

    <span class="c1"># THRESHOLD-GATED RECURSION: Only process pairs that meet the match_threshold</span>
    <span class="k">for</span> <span class="n">gt_idx</span><span class="p">,</span> <span class="n">pred_idx</span><span class="p">,</span> <span class="n">similarity_score</span> <span class="ow">in</span> <span class="n">matched_pairs_with_scores</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">gt_idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">gt_list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pred_idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">pred_list</span><span class="p">):</span>
            <span class="n">gt_item</span> <span class="o">=</span> <span class="n">gt_list</span><span class="p">[</span><span class="n">gt_idx</span><span class="p">]</span>
            <span class="n">pred_item</span> <span class="o">=</span> <span class="n">pred_list</span><span class="p">[</span><span class="n">pred_idx</span><span class="p">]</span>

            <span class="c1"># Handle floating point precision issues</span>
            <span class="n">is_above_threshold</span> <span class="o">=</span> <span class="n">similarity_score</span> <span class="o">&gt;=</span> <span class="n">match_threshold</span> <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="n">similarity_score</span> <span class="o">-</span> <span class="n">match_threshold</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-10</span>

            <span class="c1"># Only perform recursive field analysis if similarity meets threshold</span>
            <span class="k">if</span> <span class="n">is_above_threshold</span><span class="p">:</span>
                <span class="c1"># ... perform detailed field analysis ...</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Skip recursive analysis for pairs below threshold</span>
                <span class="c1"># These will be handled as FD at the object level</span>
                <span class="k">pass</span>
</code></pre></div>
<h4 id="benefits">Benefits</h4>
<ol>
<li><strong>Performance</strong>: Avoids expensive recursion for obviously poor matches</li>
<li><strong>Focus</strong>: Concentrates detailed analysis on promising matches</li>
<li><strong>Scalability</strong>: Handles large lists more efficiently</li>
<li><strong>Precision</strong>: Maintains accuracy by still counting object-level metrics</li>
</ol>
<h2 id="performance-optimizations">Performance Optimizations</h2>
<h3 id="single-traversal-architecture">Single Traversal Architecture</h3>
<p>The biggest performance gain comes from the single-traversal design:</p>
<p><strong>Before (Multiple Passes)</strong>:
1. First pass: Calculate similarity scores
2. Second pass: Generate confusion matrix
3. Third pass: Collect non-matches
4. Result: 3 traversal cost</p>
<p><strong>After (Single Pass)</strong>:
1. One pass: Calculate scores AND confusion matrix AND collect non-matches
2. Result: 1 traversal cost with identical functionality</p>
<h3 id="lazy-evaluation">Lazy Evaluation</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Add optional features using already-computed recursive result</span>
<span class="k">if</span> <span class="n">include_confusion_matrix</span><span class="p">:</span>
    <span class="n">confusion_matrix</span> <span class="o">=</span> <span class="n">recursive_result</span>

    <span class="c1"># Add derived metrics if requested</span>
    <span class="k">if</span> <span class="n">add_derived_metrics</span><span class="p">:</span>
        <span class="n">confusion_matrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_derived_metrics_to_result</span><span class="p">(</span><span class="n">confusion_matrix</span><span class="p">)</span>

    <span class="n">result</span><span class="p">[</span><span class="s2">&quot;confusion_matrix&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">confusion_matrix</span>

<span class="c1"># Add optional non-match documentation</span>
<span class="k">if</span> <span class="n">document_non_matches</span><span class="p">:</span>
    <span class="n">non_matches</span> <span class="o">=</span> <span class="n">recursive_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;non_matches&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">non_matches</span><span class="p">:</span>  <span class="c1"># Fallback to legacy method if needed</span>
        <span class="n">non_matches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_non_matches</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="n">non_matches</span> <span class="o">=</span> <span class="p">[</span><span class="n">nm</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span> <span class="k">for</span> <span class="n">nm</span> <span class="ow">in</span> <span class="n">non_matches</span><span class="p">]</span>
    <span class="n">result</span><span class="p">[</span><span class="s2">&quot;non_matches&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">non_matches</span>
</code></pre></div>
<h3 id="memory-efficiency">Memory Efficiency</h3>
<ol>
<li><strong>Hierarchical Results</strong>: Results maintain object structure without flattening</li>
<li><strong>Streaming Processing</strong>: Process fields one at a time rather than loading all into memory</li>
<li><strong>Efficient Data Structures</strong>: Use sets for tracking rather than lists where possible</li>
</ol>
<h3 id="hungarian-algorithm-optimization">Hungarian Algorithm Optimization</h3>
<p>The Hungarian algorithm runs in O(n) time, which is optimal for the assignment problem. The implementation optimizations include:</p>
<ol>
<li><strong>Early Termination</strong>: Stop when optimal assignment is found</li>
<li><strong>Sparse Matrix Handling</strong>: Efficiently handle cases with many zero similarities  </li>
<li><strong>Threshold Pre-filtering</strong>: Use match_threshold=0.0 to capture all potential matches</li>
</ol>
<h2 id="debugging-and-troubleshooting">Debugging and Troubleshooting</h2>
<h3 id="common-issues-and-solutions">Common Issues and Solutions</h3>
<h4 id="1-incorrect-similarity-scores">1. <strong>Incorrect Similarity Scores</strong></h4>
<ul>
<li><strong>Symptom</strong>: Scores don't match expectations</li>
<li><strong>Check</strong>: Field-level comparator configuration</li>
<li><strong>Debug</strong>: Add logging to <code>_compare_primitive_with_scores()</code></li>
</ul>
<h4 id="2-confusion-matrix-inconsistencies">2. <strong>Confusion Matrix Inconsistencies</strong></h4>
<ul>
<li><strong>Symptom</strong>: TP + FP  expected totals</li>
<li><strong>Check</strong>: Object vs field-level counting in list handlers</li>
<li><strong>Debug</strong>: Verify <code>_calculate_object_level_metrics()</code> logic</li>
</ul>
<h4 id="3-performance-issues">3. <strong>Performance Issues</strong></h4>
<ul>
<li><strong>Symptom</strong>: Slow comparison on large objects</li>
<li><strong>Check</strong>: Threshold-gated recursion settings</li>
<li><strong>Debug</strong>: Profile <code>compare_recursive()</code> with timing</li>
</ul>
<h4 id="4-memory-usage">4. <strong>Memory Usage</strong></h4>
<ul>
<li><strong>Symptom</strong>: High memory consumption</li>
<li><strong>Check</strong>: Result structure depth and breadth</li>
<li><strong>Debug</strong>: Monitor object creation in recursive calls</li>
</ul>
<h3 id="debugging-helper-methods">Debugging Helper Methods</h3>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">_debug_field_comparison</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">gt_val</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">pred_val</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add this method for debugging field comparisons.&quot;&quot;&quot;</span>
    <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_comparison_info</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Field: </span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  GT Value: </span><span class="si">{</span><span class="n">gt_val</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Pred Value: </span><span class="si">{</span><span class="n">pred_val</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Comparator: </span><span class="si">{</span><span class="n">info</span><span class="o">.</span><span class="n">comparator</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Threshold: </span><span class="si">{</span><span class="n">info</span><span class="o">.</span><span class="n">threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Weight: </span><span class="si">{</span><span class="n">info</span><span class="o">.</span><span class="n">weight</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Add to dispatch method for detailed logging</span>
    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dispatch_field_comparison</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">gt_val</span><span class="p">,</span> <span class="n">pred_val</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Result: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
<h3 id="testing-complex-scenarios">Testing Complex Scenarios</h3>
<p>For testing the monster functions, focus on:</p>
<ol>
<li><strong>Edge Cases</strong>: Empty lists, None values, type mismatches</li>
<li><strong>Scale Testing</strong>: Large nested structures, deep recursion</li>
<li><strong>Performance Testing</strong>: Time and memory usage under load</li>
<li><strong>Correctness Testing</strong>: Known ground truth comparisons</li>
</ol>
<h3 id="profiling-guidelines">Profiling Guidelines</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">cProfile</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pstats</span>

<span class="k">def</span><span class="w"> </span><span class="nf">profile_comparison</span><span class="p">(</span><span class="n">model1</span><span class="p">,</span> <span class="n">model2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Profile a comparison operation.&quot;&quot;&quot;</span>
    <span class="n">profiler</span> <span class="o">=</span> <span class="n">cProfile</span><span class="o">.</span><span class="n">Profile</span><span class="p">()</span>
    <span class="n">profiler</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>

    <span class="c1"># Perform the comparison</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">model1</span><span class="o">.</span><span class="n">compare_with</span><span class="p">(</span><span class="n">model2</span><span class="p">,</span> <span class="n">include_confusion_matrix</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">profiler</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span>

    <span class="c1"># Generate stats</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="n">pstats</span><span class="o">.</span><span class="n">Stats</span><span class="p">(</span><span class="n">profiler</span><span class="p">)</span>
    <span class="n">stats</span><span class="o">.</span><span class="n">sort_stats</span><span class="p">(</span><span class="s1">&#39;cumulative&#39;</span><span class="p">)</span>
    <span class="n">stats</span><span class="o">.</span><span class="n">print_stats</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>  <span class="c1"># Top 20 functions</span>

    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>
<h3 id="key-performance-metrics-to-monitor">Key Performance Metrics to Monitor</h3>
<ol>
<li><strong>Function Call Counts</strong>: Track calls to recursive methods</li>
<li><strong>Memory Allocation</strong>: Monitor object creation in loops</li>
<li><strong>Hungarian Algorithm Performance</strong>: O(n) scaling behavior</li>
<li><strong>Threshold Gate Effectiveness</strong>: Ratio of processed vs skipped recursions</li>
</ol>
<h3 id="code-maintenance-guidelines">Code Maintenance Guidelines</h3>
<p>When modifying the monster functions, follow these principles:</p>
<ol>
<li><strong>Preserve Single Traversal</strong>: Ensure all optimizations maintain one-pass processing</li>
<li><strong>Maintain API Consistency</strong>: Keep hierarchical result structures intact</li>
<li><strong>Document Design Decisions</strong>: Explain any performance vs accuracy trade-offs</li>
<li><strong>Test Edge Cases</strong>: Verify behavior with empty/null/mismatched data</li>
<li><strong>Profile Changes</strong>: Measure performance impact of modifications</li>
</ol>
<h3 id="conclusion">Conclusion</h3>
<p>The StructuredModel comparison system represents a sophisticated balance of performance, accuracy, and maintainability. The "monster functions" implement complex algorithms while maintaining clean, testable interfaces.</p>
<p>Key takeaways for developers:</p>
<ul>
<li><strong>Single Traversal</strong>: The core optimization that makes everything else possible</li>
<li><strong>Type-Based Dispatch</strong>: Clean separation of concerns for different data types</li>
<li><strong>Hungarian Matching</strong>: Optimal list comparison with O(n) complexity</li>
<li><strong>Threshold Gating</strong>: Performance optimization for deep recursion scenarios</li>
<li><strong>Hierarchical Results</strong>: Maintains interpretable structure at all levels</li>
</ul>
<p>Understanding these principles will enable effective debugging, optimization, and extension of the comparison system.</p>







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.copy", "content.code.select", "navigation.instant", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.top", "search.highlight", "content.code.copy"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="https://unpkg.com/mermaid@11/dist/mermaid.min.js"></script>
      
        <script src="../../assets/auto-redirect.js"></script>
      
    
  </body>
</html>